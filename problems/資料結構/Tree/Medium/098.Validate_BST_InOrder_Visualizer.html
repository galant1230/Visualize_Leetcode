<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>98. Validate BST - Optimized Layout</title>
    <style>
        :root {
            --primary: #8b5cf6; --bg: #0d1117; --line-active: #21262d;
            --kw: #ff7b72; --fn: #d2a8ff; --vr: #ffa657; --tp: #79c0ff;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        
        /* 視覺區 */
        .tree-stage { background: #fff; border: 1px solid #d0d7de; border-radius: 8px; height: 280px; position: relative; margin-bottom: 20px; }
        .tree-node { position: absolute; width: 34px; height: 34px; background: #fff; border: 2px solid #30363d; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; z-index: 2; transform: translateX(-50%); transition: 0.4s; font-size: 13px; }
        .node-active { border-color: var(--primary); background: #f5f3ff; transform: translateX(-50%) scale(1.1); box-shadow: 0 0 10px rgba(139,92,246,0.3); }
        .node-error { border-color: #ef4444 !important; background: #fef2f2 !important; color: #ef4444 !important; }

        /* 代碼區 - 精排 */
        .grid { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px; }
        .code-window { background: var(--bg); border-radius: 8px; overflow: hidden; border: 1px solid #30363d; }
        .code-header { background: #161b22; padding: 10px 15px; border-bottom: 1px solid #30363d; color: #8b949e; font-size: 12px; }
        .code-panel { color: #c9d1d9; padding: 15px; font-family: 'Fira Code', 'Courier New', monospace; font-size: 12px; height: 350px; overflow-y: auto; line-height: 1.7; }
        .line { display: flex; opacity: 0.3; border-left: 3px solid transparent; }
        .line-num { width: 30px; color: #484f58; text-align: right; padding-right: 15px; }
        .active-line { opacity: 1; background: var(--line-active); border-left-color: var(--primary); }
        .indent-1 { padding-left: 20px; }
        .indent-2 { padding-left: 40px; }
        .indent-3 { padding-left: 60px; }

        /* 資訊區 */
        .range-box { background: #161b22; color: #c9d1d9; padding: 12px; border-radius: 8px; border: 1px solid #30363d; margin-bottom: 15px; font-family: monospace; }
        #stepDesc { padding: 12px; background: #f5f3ff; border: 1px solid #ddd6fe; border-radius: 8px; font-size: 13px; min-height: 60px; margin-bottom: 15px; color: #4c1d95; }
        
        .comp-table { width: 100%; border-collapse: collapse; font-size: 11px; color: #c9d1d9; margin-top: 10px; border: 1px solid #30363d; }
        .comp-table th, .comp-table td { border: 1px solid #30363d; padding: 6px; text-align: left; }
        
        svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        line { stroke: #d0d7de; stroke-width: 1.5; }
        .k { color: var(--kw); } .f { color: var(--fn); } .v { color: var(--vr); }
    </style>
</head>
<body>

<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <select id="caseSelect" onchange="init()" style="padding:8px; border-radius:6px; font-weight:600; cursor:pointer;">
            <option value="case1">Case 1: Valid BST [2, 1, 3]</option>
            <option value="case2">Case 2: Invalid BST [5, 1, 4, null, null, 3, 6]</option>
        </select>
        <div style="display: flex; gap: 8px;">
            <button onclick="runStep()" style="background:var(--primary); color:white; border:none; padding:8px 18px; border-radius:6px; cursor:pointer; font-weight:600;">下一步 ▶</button>
            <button onclick="init()" style="padding:8px 15px; border-radius:6px; cursor:pointer; border:1px solid #d0d7de;">重置</button>
        </div>
    </div>

    <div class="tree-stage">
        <svg id="svgLines"></svg>
        <div id="treeNodes"></div>
    </div>

    <div class="grid">
        <div class="code-window">
            <div class="code-header">solution.py</div>
            <div class="code-panel" id="codePanel">
                </div>
        </div>
        
        <div class="status-wrapper">
            <span style="font-size:11px; font-weight:bold; color:#57606a;">BST RANGE CONSTRAINTS</span>
            <div class="range-box" id="rangeBox">low: -∞ | high: +∞</div>
            <div id="stepDesc"></div>
            
            <div style="background:#161b22; padding:15px; border-radius:8px; border:1px solid #30363d;">
                <span style="font-size:11px; font-weight:bold; color:var(--fn)">BST 性質與複雜度分析</span>
                <p style="font-size:11px; color:#8b949e; margin: 5px 0;">子樹必須遵守「繼承自祖先」的區間限制。</p>
                <table class="comp-table">
                    <tr><th>維度</th><th>複雜度</th><th>說明</th></tr>
                    <tr><td>時間</td><td>$O(N)$</td><td>每個節點皆檢查一次。</td></tr>
                    <tr><td>空間 (遞迴)</td><td>$O(H)$</td><td>取決於樹高，最壞情況為 $O(N)$。</td></tr>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    let step = 0;
    const treeData = {
        case1: [
            {id:2, v:2, x:50, y:40, p:null}, {id:1, v:1, x:30, y:120, p:2}, {id:3, v:3, x:70, y:120, p:2}
        ],
        case2: [
            {id:5, v:5, x:50, y:40, p:null}, {id:1, v:1, x:30, y:110, p:5}, {id:4, v:4, x:70, y:110, p:5},
            {id:3, v:3, x:60, y:190, p:4}, {id:6, v:6, x:80, y:190, p:4}
        ]
    };

    const pyCodeLines = [
        {txt: `<span class="k">def</span> <span class="f">isValidBST</span>(<span class="v">root</span>):`, indent: 0},
        {txt: `<span class="k">def</span> <span class="f">validate</span>(<span class="v">node</span>, <span class="v">low</span>, <span class="v">high</span>):`, indent: 1},
        {txt: `<span class="k">if not</span> <span class="v">node</span>: <span class="k">return True</span>`, indent: 2},
        {txt: `<span class="k">if not</span> (<span class="v">low</span> < <span class="v">node.val</span> < <span class="v">high</span>):`, indent: 2},
        {txt: `<span class="k">return False</span>`, indent: 3},
        {txt: `<span class="k">return</span> (<span class="f">validate</span>(<span class="v">node.left</span>, <span class="v">low</span>, <span class="v">node.val</span>) <span class="k">and</span>`, indent: 2},
        {txt: `<span class="f">validate</span>(<span class="v">node.right</span>, <span class="v">node.val</span>, <span class="v">high</span>))`, indent: 3}
    ];

    const traces = {
        case1: [
            { active: 2, l: [2, 18], line: 1, d: "根節點 2，無範圍限制。(-∞, +∞) 合法。" },
            { active: 1, l: [-Infinity, 2], line: 5, d: "左子節點 1。繼承上限 2。(-∞, 2) 合法。" },
            { active: 3, l: [2, Infinity], line: 6, d: "右子節點 3。繼承下限 2。(2, +∞) 合法。" }
        ],
        case2: [
            { active: 5, l: [-Infinity, Infinity], line: 1, d: "根節點 5。(-∞, +∞) 合法。" },
            { active: 1, l: [-Infinity, 5], line: 5, d: "左子節點 1。(-∞, 5) 合合。" },
            { active: 4, l: [5, Infinity], line: 6, d: "右子節點 4。下限設為 5。" },
            { active: 4, l: [5, Infinity], line: 4, isErr: true, d: "<b>失敗！</b>節點 4 必須大於 5。右子樹所有節點都得比根大。" }
        ]
    };

    function init() { step = 0; renderCode(); render(); }
    function runStep() { const c = document.getElementById('caseSelect').value; if (step < traces[c].length-1) { step++; render(); } }
    
    function renderCode() {
        const panel = document.getElementById('codePanel');
        panel.innerHTML = pyCodeLines.map((l, i) => `
            <div class="line" id="line-${i}">
                <div class="line-num">${i + 1}</div>
                <div class="line-content indent-${l.indent}">${l.txt}</div>
            </div>
        `).join('');
    }

    function render() {
        const cKey = document.getElementById('caseSelect').value;
        const data = traces[cKey][step];
        document.getElementById('stepDesc').innerHTML = data.d;
        document.getElementById('rangeBox').innerText = `low: ${data.l[0] === -Infinity ? '-∞' : data.l[0]} | high: ${data.l[1] === Infinity ? '+∞' : data.l[1]}`;
        
        document.querySelectorAll('.line').forEach(l => l.classList.remove('active-line'));
        document.getElementById(`line-${data.line}`).classList.add('active-line');

        const container = document.getElementById('treeNodes');
        const svg = document.getElementById('svgLines');
        container.innerHTML = ''; svg.innerHTML = '';
        treeData[cKey].forEach(n => {
            const div = document.createElement('div');
            div.className = 'tree-node' + (data.active === n.id ? ' node-active' : '') + (data.isErr && data.active === n.id ? ' node-error' : '');
            div.style.left = n.x + '%'; div.style.top = n.y + 'px'; div.innerText = n.v;
            container.appendChild(div);
            if (n.p !== null) {
                const parent = treeData[cKey].find(p => p.id === n.p);
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", n.x + "%"); line.setAttribute("y1", n.y);
                line.setAttribute("x2", parent.x + "%"); line.setAttribute("y2", parent.y + 17);
                svg.appendChild(line);
            }
        });
    }
    init();
</script>
</body>
</html>
