<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>Trie Pro Visualizer - Fixed</title>
    <style>
        :root {
            --bg: #f8fafc; --card-yellow: #fffbeb; --border-yellow: #fde68a;
            --monitor-bg: #1e1e1e; --editor-bg: #0d1117; --tree-bg: #000;
            --primary: #f59e0b; --node-purple: #4c1d95; --success: #22c55e; --fail: #ef4444;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; overflow-x: hidden; }
        .dashboard { max-width: 1400px; margin: auto; display: grid; gap: 15px; }

        /* 控制台 */
        .control-panel { background: var(--card-yellow); border: 1.5px solid var(--border-yellow); border-radius: 12px; padding: 15px; display: flex; align-items: center; gap: 15px; }
        select, input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-run { background: var(--primary); color: white; }
        .btn-auto { background: #6366f1; color: white; }

        /* 主區域佈局 */
        .main-layout { display: grid; grid-template-columns: 300px 1fr 450px; gap: 15px; height: 600px; }

        /* 左側日誌 */
        .side-panel { background: var(--monitor-bg); border-radius: 12px; padding: 15px; color: #d1d5db; display: flex; flex-direction: column; }
        .log-area { flex: 1; overflow-y: auto; font-family: monospace; font-size: 13px; margin-top: 10px; border-top: 1px solid #333; padding-top: 10px; }
        .log-entry { margin-bottom: 6px; padding-left: 8px; border-left: 3px solid var(--primary); }

        /* 中間 Trie 樹 (黑色背景) */
        .tree-container { background: var(--tree-bg); border-radius: 12px; position: relative; border: 1px solid #333; overflow: hidden; }
        .node {
            position: absolute; width: 36px; height: 36px; border-radius: 50%; background: #2d1b36;
            border: 2px solid var(--node-purple); display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 14px; z-index: 5; transition: 0.3s;
        }
        .node.is-end { border-color: var(--success); background: #064e3b; box-shadow: 0 0 10px var(--success); }
        .node.highlight { border-color: var(--primary); transform: scale(1.2); box-shadow: 0 0 15px var(--primary); }
        
        .line-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .edge { stroke: rgba(255,255,255,0.15); stroke-width: 1.5; }

        /* 右側 IDE */
        .editor { background: var(--editor-bg); border-radius: 12px; border: 1px solid #30363d; overflow: hidden; display: flex; flex-direction: column; }
        .code-view { flex: 1; padding: 10px 0; font-family: 'Fira Code', monospace; font-size: 12px; color: #c9d1d9; }
        .line-row { padding-left: 40px; position: relative; line-height: 1.6; }
        .line-active { background: #21262d; border-left: 3px solid var(--primary); }
        .kw { color: #ff7b72; } .fn { color: #d2a8ff; }

        /* 底部資訊 */
        .footer { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-card { padding: 12px; border-radius: 8px; border-left: 5px solid; font-size: 13px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="control-panel">
        <b>Trie API:</b>
        <select id="api-select">
            <option value="insert">insert</option>
            <option value="search">search</option>
            <option value="startsWith">startsWith</option>
        </select>
        <input type="text" id="api-input" value="apple" style="width: 100px;">
        <button class="btn-run" onclick="manualRun()">執行</button>
        <button class="btn-auto" onclick="runExampleSequence()">⚡ 跑測試序列</button>
        <button onclick="location.reload()" style="background:#444; color:white;">重置</button>
    </div>

    <div class="main-layout">
        <div class="side-panel">
            <b>Execution Log:</b>
            <div id="log-container" class="log-area"></div>
        </div>

        <div class="tree-container" id="tree-box">
            <svg class="line-svg" id="svg-layer"></svg>
            <div id="node-layer"></div>
        </div>

        <div class="editor">
            <div style="padding:5px 15px; background:#161b22; font-size:11px; color:#8b949e;">trie.py</div>
            <div class="code-view" id="code-box"></div>
        </div>
    </div>

    <div class="footer">
        <div class="info-card" style="background:#f0fdf4; border-color:var(--success);">
            <b>Time: $O(L)$</b> | <b>Space: $O(N \cdot L \cdot 26)$</b>
        </div>
        <div class="info-card" style="background:#eff6ff; border-color:#3b82f6;">
            <b>Logic:</b> <code>search</code> 需檢查 <code>isEnd</code>；<code>startsWith</code> 只要路徑通即可。
        </div>
    </div>
</div>



<script>
// Trie 邏輯對象
class TrieNode {
    constructor(char, x, y) {
        this.char = char; this.children = {}; this.isEnd = false; this.x = x; this.y = y;
        this.id = 'n' + Math.random().toString(36).substr(2, 5);
    }
}

let root = new TrieNode('R', 150, 40);
let allNodes = [root];

const codeLines = [
    {t: "def insert(self, word):", fn: "insert"},
    {t: "    node = self.root", i: 1},
    {t: "    for c in word:", i: 1},
    {t: "        if c not in node.children:", i: 2},
    {t: "            node.children[c] = TrieNode()", i: 3},
    {t: "        node = node.children[c]", i: 2},
    {t: "    node.isEnd = True", i: 1},
    {t: "def search(self, word):", fn: "search"},
    {t: "    node = self._navigate(word)", i: 1},
    {t: "    return node and node.isEnd", i: 1},
    {t: "def startsWith(self, prefix):", fn: "startsWith"},
    {t: "    node = self._navigate(prefix)", i: 1},
    {t: "    return node is not None", i: 1}
];

function setup() {
    const box = document.getElementById('code-box');
    box.innerHTML = codeLines.map((l, i) => `<div class="line-row" id="ln-${i}" style="padding-left:${(l.i||0)*20 + 40}px">${highlight(l.t)}</div>`).join('');
    renderTree();
}

function highlight(t) { return t.replace(/def |if |for |in |not |return |is /g, x => `<span class="kw">${x}</span>`).replace(/insert|search|startsWith/g, x => `<span class="fn">${x}</span>`); }

function renderTree() {
    const nodeLayer = document.getElementById('node-layer');
    const svgLayer = document.getElementById('svg-layer');
    nodeLayer.innerHTML = ''; svgLayer.innerHTML = '';
    
    allNodes.forEach(n => {
        const div = document.createElement('div');
        div.className = `node ${n.isEnd ? 'is-end' : ''}`;
        div.id = n.id;
        div.style.left = n.x - 18 + 'px'; div.style.top = n.y - 18 + 'px';
        div.innerText = n.char;
        nodeLayer.appendChild(div);

        for (let key in n.children) {
            const child = n.children[key];
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", n.x); line.setAttribute("y1", n.y);
            line.setAttribute("x2", child.x); line.setAttribute("y2", child.y);
            line.setAttribute("class", "edge");
            svgLayer.appendChild(line);
        }
    });
}

async function manualRun() {
    const op = document.getElementById('api-select').value;
    const word = document.getElementById('api-input').value;
    if (!word) return;

    document.querySelectorAll('.line-row').forEach(r => r.classList.remove('line-active'));
    const startIdx = codeLines.findIndex(l => l.fn === op);
    document.getElementById(`ln-${startIdx}`).classList.add('line-active');

    let curr = root;
    let found = true;

    for (let i = 0; i < word.length; i++) {
        const char = word[i];
        // 視覺高亮當前節點
        document.getElementById(curr.id).classList.add('highlight');
        await new Promise(r => setTimeout(r, 200));

        if (op === 'insert') {
            if (!curr.children[char]) {
                const newNode = new TrieNode(char, curr.x + (Math.random()*40-20), curr.y + 60);
                curr.children[char] = newNode;
                allNodes.push(newNode);
                renderTree();
            }
            curr = curr.children[char];
        } else {
            if (!curr.children[char]) {
                found = false;
                break;
            }
            curr = curr.children[char];
        }
    }

    let result = '';
    if (op === 'insert') {
        curr.isEnd = true;
        result = 'null';
    } else if (op === 'search') {
        result = (found && curr.isEnd) ? 'true' : 'false';
    } else {
        result = found ? 'true' : 'false';
    }

    const log = document.getElementById('log-container');
    log.innerHTML += `<div class="log-entry">${op}("${word}") → <b style="color:var(--primary)">${result}</b></div>`;
    log.scrollTop = log.scrollHeight;
    
    document.getElementById(curr.id).classList.add('highlight');
    renderTree();
}

async function runExampleSequence() {
    const seq = [
        {a:'insert', v:'apple'}, {a:'search', v:'apple'}, {a:'search', v:'app'},
        {a:'startsWith', v:'app'}, {a:'insert', v:'app'}, {a:'search', v:'app'}
    ];
    for (let step of seq) {
        document.getElementById('api-select').value = step.a;
        document.getElementById('api-input').value = step.v;
        await manualRun();
        await new Promise(r => setTimeout(r, 600));
    }
}

setup();
</script>
</body>
</html>
